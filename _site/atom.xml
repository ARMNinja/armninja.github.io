<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

 <title>ARM Ninja</title>
 <link href="http://arm.ninja/atom.xml" rel="self"/>
 <link href="http://arm.ninja/"/>
 <updated>2016-07-18T00:14:08-07:00</updated>
 <id>http://arm.ninja</id>
 <author>
   <name>@theqlabs</name>
   <email></email>
 </author>

 
 <entry>
   <title>Introduction to the Binary Ninja API</title>
   <link href="http://arm.ninja/2016/03/08/intro-to-binary-ninja-api/"/>
   <updated>2016-03-08T00:00:00-08:00</updated>
   <id>http://arm.ninja/2016/03/08/intro-to-binary-ninja-api</id>
   <content type="html">&lt;p&gt;As ninjas we value time, and the faster we are able to do something the better. Because of this I try to find tools to expedite my work, and so I have started messing around with &lt;a href=&quot;https://binary.ninja&quot;&gt;Binary Ninja&lt;/a&gt; from the cool dudes over at &lt;a href=&quot;https://vector35.com/&quot;&gt;Vector 35&lt;/a&gt; whom I love dearly for the incredible contributions they have made to CTF over the years, my favorite being &lt;a href=&quot;https://github.com/ctfs/write-ups-2015/blob/master/csaw-ctf-2015/reverse/hacking-time-200/HackingTime_03e852ace386388eb88c39a02f88c773.nes&quot;&gt;Hacking Time&lt;/a&gt; and &lt;a href=&quot;https://github.com/Vector35/PwnAdventureZ&quot;&gt;PwnAdventureZ&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;While the UI is super sexy and clean, this post is focused on the Python &lt;code class=&quot;highlighter-rouge&quot;&gt;API&lt;/code&gt; to see how quickly I can build a tool to &lt;a href=&quot;http://arm.ninja/2016/03/07/decoding-syscalls-in-arm64/&quot;&gt;Decode ARM64 syscalls&lt;/a&gt; based on my last post. Thanks to &lt;a href=&quot;twitter.com/psifertex&quot;&gt;Jordan&lt;/a&gt; for inviting me to the &lt;code class=&quot;highlighter-rouge&quot;&gt;BETA&lt;/code&gt; and thanks to Peter who spent a couple hours solving my super novice issues and made this post possible. As always, thanks to &lt;a href=&quot;http://www.twitter.com/rotlogix&quot;&gt;rotlogix&lt;/a&gt; who continues to inspire me to write these posts.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;note: binary ninja has been lovingly abbrieviated &lt;code class=&quot;highlighter-rouge&quot;&gt;binja&lt;/code&gt;, and will be referred to as such through the post&lt;/em&gt;&lt;/p&gt;

&lt;h4 id=&quot;setting-up&quot;&gt;Setting up&lt;/h4&gt;

&lt;p&gt;Typical of my luck, I happened to run into every known and unknown issue while getting set up. Luckily the V35 guys were super helpful getting it straightened out but will document here in case you run into these problems. After getting my copy of the software, (an App Bundle for OS X) I ran into a problem with &lt;code class=&quot;highlighter-rouge&quot;&gt;homebrew&lt;/code&gt; version of Python 2.7 causing &lt;a href=&quot;https://asciinema.org/a/cjnff76u305mn9ceixtimz4ns&quot;&gt;this issue&lt;/a&gt; which was later documented &lt;a href=&quot;https://github.com/Vector35/binaryninja-docs/issues/186&quot;&gt;here&lt;/a&gt; with a temporary solution of simply using the native OS X version of Python:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;PYTHONPATH=$PYTHONPATH:/Applications/Binary\ Ninja.app/Contents/Resources/python python
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;After this I ran into some errors resulting from a phantom &lt;code class=&quot;highlighter-rouge&quot;&gt;dylib&lt;/code&gt; on my system causing version mismatches and preventing me from using the &lt;code class=&quot;highlighter-rouge&quot;&gt;Mach-O&lt;/code&gt; support. You’re unlikely to run into this, however it is convient to ensure that your &lt;code class=&quot;highlighter-rouge&quot;&gt;UI&lt;/code&gt; version matches your &lt;code class=&quot;highlighter-rouge&quot;&gt;API&lt;/code&gt; version by running:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;python -c &quot;import binaryninja; print binaryninja.core_version&quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;After spending some more time with different setups (&lt;em&gt;and trust me, the homebrew vs native python issue is a smash-laptop-against-a-wall type of problem&lt;/em&gt;) I would recommend you install &lt;code class=&quot;highlighter-rouge&quot;&gt;virtualenv&lt;/code&gt; for &lt;code class=&quot;highlighter-rouge&quot;&gt;binja&lt;/code&gt; which is what I am running now and it’s working great. The main reason is that &lt;code class=&quot;highlighter-rouge&quot;&gt;virtualenv&lt;/code&gt; will install a fresh copy of Python without messing with whatever is on your main system, you can get the dependencies installed and run &lt;code class=&quot;highlighter-rouge&quot;&gt;workon binja&lt;/code&gt; to quickly get back to your environment.&lt;/p&gt;

&lt;p&gt;A great guide to follow would be the &lt;a href=&quot;http://docs.python-guide.org/en/latest/dev/virtualenvs/&quot;&gt;Hitchhiker’s Guide to Python&lt;/a&gt;&lt;/p&gt;

&lt;h4 id=&quot;my-setup&quot;&gt;My Setup&lt;/h4&gt;

&lt;p&gt;Requires &lt;code class=&quot;highlighter-rouge&quot;&gt;virtualenvwrapper.sh&lt;/code&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;mkvirtualenv binja&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;workon binja&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;pip freeze &amp;gt; requirements.txt&lt;/code&gt; yields:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;appnope==0.1.0
decorator==4.0.9
gnureadline==6.3.3
ipython==4.1.2
ipython-genutils==0.1.0
path.py==8.1.2
pexpect==4.0.1
pickleshare==0.6
ptyprocess==0.5.1
pycrypto==2.6.1
pyreadline==2.1
simplegeneric==0.8.1
traitlets==4.1.0
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;If you put the above into a &lt;code class=&quot;highlighter-rouge&quot;&gt;requirements.txt&lt;/code&gt; file you can run &lt;code class=&quot;highlighter-rouge&quot;&gt;pip install -r requirements.txt&lt;/code&gt; &lt;strong&gt;inside&lt;/strong&gt; your virtualenv &lt;code class=&quot;highlighter-rouge&quot;&gt;binja&lt;/code&gt; and have the same setup. I like to run inside &lt;code class=&quot;highlighter-rouge&quot;&gt;iPython&lt;/code&gt; mostly because of the tab-complete features for quickly accessing objects.&lt;/p&gt;

&lt;h4 id=&quot;throwing-down&quot;&gt;Throwing Down&lt;/h4&gt;

&lt;p&gt;I was given a block of sample code to leverage the Python &lt;code class=&quot;highlighter-rouge&quot;&gt;API&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;from binaryninja import *
import time
bv = BinaryViewType[&#39;Mach-O&#39;].open(&quot;stack1&quot;)
bv.update_analysis()
time.sleep(5)
for func in bv.functions:
   print func.symbol.name
   for block in func.basic_blocks:
      print hex(block.start), hex(block.end)
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;which results in the following for &lt;a href=&quot;https://github.com/deadbits/InsecureProgramming&quot;&gt;Gera’s&lt;/a&gt; &lt;code class=&quot;highlighter-rouge&quot;&gt;stack1&lt;/code&gt; binary:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;_main
0x100000ea0L 0x100000ef3L
0x100000f04L 0x100000f1eL
0x100000ef3L 0x100000f04L
0x100000f2aL 0x100000f36L
0x100000f1eL 0x100000f2aL
___stack_chk_fail
0x100000f30L 0x100000f36L
_gets
0x100000f36L 0x100000f3cL
_printf
0x100000f3cL 0x100000f42L
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;It should be noted that currently in &lt;strong&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;BETA&lt;/code&gt;&lt;/strong&gt; the &lt;code class=&quot;highlighter-rouge&quot;&gt;time.sleep(5)&lt;/code&gt; function is required due the lack of a callback, so there is no way to know when your analysis is complete. While this makes things blazingly fast for larger binaries, adjusting &lt;code class=&quot;highlighter-rouge&quot;&gt;time.sleep(5)&lt;/code&gt; is annoying and I was warned that this is being solved by implementing proper callback functionality.&lt;/p&gt;

&lt;p&gt;Despite this we see that &lt;code class=&quot;highlighter-rouge&quot;&gt;binja&lt;/code&gt; performs as expected, it finds the symbols: &lt;code class=&quot;highlighter-rouge&quot;&gt;_main&lt;/code&gt;, &lt;code class=&quot;highlighter-rouge&quot;&gt;__stack_chk_fail&lt;/code&gt;, &lt;code class=&quot;highlighter-rouge&quot;&gt;_gets&lt;/code&gt;, &lt;code class=&quot;highlighter-rouge&quot;&gt;_printf&lt;/code&gt; and displays the start and ending addresses for each basic block associated with each symbol.&lt;/p&gt;

&lt;h4 id=&quot;binja-plugin-to-decode-arm64-syscalls&quot;&gt;Binja plugin to decode ARM64 syscalls&lt;/h4&gt;

&lt;p&gt;Now that we have a basic example working, we are ready to attempt to write a plug-in that decodes ARM64 syscalls - the binary I will be using is &lt;code class=&quot;highlighter-rouge&quot;&gt;cbd&lt;/code&gt;, Samsung’s CP Boot Daemon - a crude algorithm for doing this is:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Search for supervisor call exceptions in &lt;code class=&quot;highlighter-rouge&quot;&gt;ARM64&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;Check the &lt;code class=&quot;highlighter-rouge&quot;&gt;immediate&lt;/code&gt; value being moved to &lt;code class=&quot;highlighter-rouge&quot;&gt;X8&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;Lookup the value to identify the &lt;code class=&quot;highlighter-rouge&quot;&gt;syscall&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;To do this in &lt;code class=&quot;highlighter-rouge&quot;&gt;binja&lt;/code&gt; we start similar to the above example, by recursing through each &lt;code class=&quot;highlighter-rouge&quot;&gt;basic block&lt;/code&gt; but instead of just printing the addresses, we look for all &lt;code class=&quot;highlighter-rouge&quot;&gt;SVC&lt;/code&gt; instructions. If you don’t remember why, go back and read my &lt;a href=&quot;http://arm.ninja/2016/03/07/decoding-syscalls-in-arm64/&quot;&gt;post&lt;/a&gt; on the subject.&lt;/p&gt;

&lt;p&gt;Printing each &lt;code class=&quot;highlighter-rouge&quot;&gt;basic_block&lt;/code&gt; object in &lt;code class=&quot;highlighter-rouge&quot;&gt;binja&lt;/code&gt; is easy, and looks like this:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# Isolate a function object, f1:

f1 = bv.functions[0]
f1.basic_blocks

&amp;gt;&amp;gt;&amp;gt; [&amp;lt;block: aarch64@0x400f2c-0x400f44&amp;gt;]
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;and we can get the &lt;code class=&quot;highlighter-rouge&quot;&gt;basic_block&lt;/code&gt; &lt;strong&gt;start&lt;/strong&gt; and &lt;strong&gt;end&lt;/strong&gt; address with:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# Isolate a basic_block object, f1b1:
f1b1 = f1.basic_blocks[0]

# Function 1, Basic Block 1:
hex(f1b1.start)
&amp;gt;&amp;gt;&amp;gt; &#39;0x400f2cL&#39;

hex(f1b1.end)
&amp;gt;&amp;gt;&amp;gt; &#39;0x400f44L&#39;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;So we’ll want to generate all instructions between &lt;code class=&quot;highlighter-rouge&quot;&gt;hex(f1b1.start)&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;hex(f1b1.end)&lt;/code&gt; doing so looks like:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;ins = []
start = f1b1.start
end = f1b1.end
while start != end:
  x, size = bv.arch.get_instruction_text(bv.read(start, 4), start)
  ins.append(x)
  start += size
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;The biggest piece of this to understand is the &lt;code class=&quot;highlighter-rouge&quot;&gt;get_instruction_text()&lt;/code&gt; function located in &lt;code class=&quot;highlighter-rouge&quot;&gt;__init__.py&lt;/code&gt;:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/Screen Shot 2016-03-11 at 4.47.35 PM.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;So &lt;code class=&quot;highlighter-rouge&quot;&gt;get_instruction_text()&lt;/code&gt; wants &lt;code class=&quot;highlighter-rouge&quot;&gt;data&lt;/code&gt;, &lt;code class=&quot;highlighter-rouge&quot;&gt;addr&lt;/code&gt; as its arguments, obviously we know the address for our &lt;code class=&quot;highlighter-rouge&quot;&gt;basic_block&lt;/code&gt; given above using &lt;code class=&quot;highlighter-rouge&quot;&gt;f1b1.start&lt;/code&gt;, but to get the data we use the &lt;code class=&quot;highlighter-rouge&quot;&gt;bv.read()&lt;/code&gt; function which requires &lt;code class=&quot;highlighter-rouge&quot;&gt;offset&lt;/code&gt; and a &lt;code class=&quot;highlighter-rouge&quot;&gt;length&lt;/code&gt;. &lt;code class=&quot;highlighter-rouge&quot;&gt;length&lt;/code&gt; is defined as 4 for &lt;code class=&quot;highlighter-rouge&quot;&gt;ARM64&lt;/code&gt; due to its fixed 4-byte instruction size. For &lt;code class=&quot;highlighter-rouge&quot;&gt;x86_64&lt;/code&gt; you would use &lt;code class=&quot;highlighter-rouge&quot;&gt;16&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/Screen Shot 2016-03-12 at 1.18.47 AM.png&quot; alt=&quot;bv.read()&quot; /&gt;&lt;/p&gt;

&lt;p&gt;The instructions returned from the above code:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;[[&#39;stp&#39;, &#39;   &#39;, &#39;x29&#39;, &#39;, &#39;, &#39;x30&#39;, &#39;, &#39;, &#39;[&#39;, &#39;sp&#39;, &#39;, #&#39;, &#39;-0x10&#39;, &#39;]!&#39;], 
[&#39;adrp&#39;, &#39;   &#39;, &#39;x0&#39;, &#39;, &#39;, &#39;0x473000&#39;], 
[&#39;mov&#39;, &#39;    &#39;, &#39;x29&#39;, &#39;, &#39;, &#39;sp&#39;], 
[&#39;add&#39;, &#39;    &#39;, &#39;x0&#39;, &#39;, &#39;, &#39;x0&#39;, &#39;, &#39;, &#39;#&#39;, &#39;0xf50&#39;], 
[&#39;bl&#39;, &#39;     &#39;, &#39;0x448214&#39;], [&#39;bl&#39;, &#39;     &#39;, &#39;0x439c28&#39;]]
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h4 id=&quot;search-for-supervisor-call-exceptions-in-arm64&quot;&gt;Search for supervisor call exceptions in &lt;code class=&quot;highlighter-rouge&quot;&gt;ARM64&lt;/code&gt;:&lt;/h4&gt;
&lt;p&gt;A quick-and-dirty algorithm:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Loop:
    &lt;ul&gt;
      &lt;li&gt;Enter &lt;code class=&quot;highlighter-rouge&quot;&gt;function&lt;/code&gt;&lt;/li&gt;
      &lt;li&gt;Enter &lt;code class=&quot;highlighter-rouge&quot;&gt;basic_block&lt;/code&gt;&lt;/li&gt;
      &lt;li&gt;Enumerate instructions in &lt;code class=&quot;highlighter-rouge&quot;&gt;basic_block&lt;/code&gt;&lt;/li&gt;
      &lt;li&gt;Search for &lt;code class=&quot;highlighter-rouge&quot;&gt;SVC&lt;/code&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Because the instruction has spaces and its list type is not string-y enough for Python, we’ll need to do some Pythonic magic (&lt;em&gt;thanks Oren for helping with this part!&lt;/em&gt;):&lt;/p&gt;

&lt;h5 id=&quot;putting-it-all-together&quot;&gt;Putting it all together&lt;/h5&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;for func in bv.functions:
     for bb in func.basic_blocks:
     	ins = []
		start = bb.start
		end = bb.end
		while start != end:
    		x, size = bv.arch.get_instruction_text(bv.read(start, 4), start)
    		ins.append(x)
    		start += size
    	for index, item in enumerate(ins):
    		if &#39;svc&#39; in &#39;&#39;.join(map(str, ins[index])):
        		print &quot;function: %s&quot; % func
        		print &quot;basic block: %s&quot; % bb
        		print &quot;MOV: %s&quot; % ins[index-1]
        		print &quot;SVC: %s&quot; % ins[index]

&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;we found &lt;strong&gt;38&lt;/strong&gt; &lt;code class=&quot;highlighter-rouge&quot;&gt;SVC&lt;/code&gt; calls in &lt;code class=&quot;highlighter-rouge&quot;&gt;cbd&lt;/code&gt; - &lt;em&gt;WOOHOO&lt;/em&gt; - the above returns:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;function: &amp;lt;func: aarch64@0x434268&amp;gt;
basic block: &amp;lt;block: aarch64@0x434268-0x43427c&amp;gt;
MOV: [&#39;mov&#39;, &#39;    &#39;, &#39;x8&#39;, &#39;, &#39;, &#39;#&#39;, &#39;0xae&#39;]
SVC: [&#39;svc&#39;, &#39;    &#39;, &#39;#&#39;, &#39;0&#39;]

function: &amp;lt;func: aarch64@0x4342f8&amp;gt;
basic block: &amp;lt;block: aarch64@0x4342f8-0x43430c&amp;gt;
MOV: [&#39;mov&#39;, &#39;    &#39;, &#39;x8&#39;, &#39;, &#39;, &#39;#&#39;, &#39;0x50&#39;]
SVC: [&#39;svc&#39;, &#39;    &#39;, &#39;#&#39;, &#39;0&#39;]

function: &amp;lt;func: aarch64@0x434310&amp;gt;
basic block: &amp;lt;block: aarch64@0x434310-0x434318&amp;gt;
MOV: [&#39;mov&#39;, &#39;    &#39;, &#39;x8&#39;, &#39;, &#39;, &#39;#&#39;, &#39;0x5e&#39;]
SVC: [&#39;svc&#39;, &#39;    &#39;, &#39;#&#39;, &#39;0&#39;]

function: &amp;lt;func: aarch64@0x434328&amp;gt;
basic block: &amp;lt;block: aarch64@0x434328-0x43433c&amp;gt;
MOV: [&#39;mov&#39;, &#39;    &#39;, &#39;x8&#39;, &#39;, &#39;, &#39;#&#39;, &#39;0x65&#39;]
SVC: [&#39;svc&#39;, &#39;    &#39;, &#39;#&#39;, &#39;0&#39;]

...
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h4 id=&quot;check-the-immediate-value-being-moved-to-x8&quot;&gt;Check the &lt;code class=&quot;highlighter-rouge&quot;&gt;immediate&lt;/code&gt; value being moved to &lt;code class=&quot;highlighter-rouge&quot;&gt;X8&lt;/code&gt;&lt;/h4&gt;

&lt;p&gt;Using this we can see we have addresses for the &lt;code class=&quot;highlighter-rouge&quot;&gt;func&lt;/code&gt; and address ranges for the &lt;code class=&quot;highlighter-rouge&quot;&gt;basic_blocks&lt;/code&gt;. This should be all we need to disassemble the functions and look for the &lt;code class=&quot;highlighter-rouge&quot;&gt;MOV X8, &amp;lt;immediate&amp;gt;&lt;/code&gt; we need to decode the correct &lt;code class=&quot;highlighter-rouge&quot;&gt;syscall&lt;/code&gt;.&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;for index, item in enumerate(ins):
  count = 0
  if &#39;svc&#39; in &#39;&#39;.join(map(str, ins[index])):
    for iter in ins[index-1]:
      if count == 5:
        print &quot;syscall: %s @ func: %s &quot; % (iter, func)
        count += 1
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;Don’t judge me&lt;/strong&gt;, it’s late and the above code “works” by maybe one sense of the defintion. In any case we get the syscalls printed out along with the function it is associated with. I print the function because there is a very large chance that the function is just a handler for the syscall and can be renamed or labeled as such. (ex.: &lt;code class=&quot;highlighter-rouge&quot;&gt;0x22&lt;/code&gt; is &lt;code class=&quot;highlighter-rouge&quot;&gt;sys_nice&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;func@0x42a19c&lt;/code&gt; can be labeled &lt;code class=&quot;highlighter-rouge&quot;&gt;sys_nice_handler&lt;/code&gt;.)&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;syscall: 0x22 @ func: &amp;lt;func: aarch64@0x42a19c&amp;gt;
syscall: 0x4f @ func: &amp;lt;func: aarch64@0x42b57c&amp;gt;
syscall: 0x40 @ func: &amp;lt;func: aarch64@0x434250&amp;gt;
syscall: 0xae @ func: &amp;lt;func: aarch64@0x434268&amp;gt;
syscall: 0x3f @ func: &amp;lt;func: aarch64@0x434280&amp;gt;
syscall: 0x2b @ func: &amp;lt;func: aarch64@0x4342e0&amp;gt;
syscall: 0x50 @ func: &amp;lt;func: aarch64@0x4342f8&amp;gt;
syscall: 0x5e @ func: &amp;lt;func: aarch64@0x434310&amp;gt;
syscall: 0x65 @ func: &amp;lt;func: aarch64@0x434328&amp;gt;
syscall: 0x19 @ func: &amp;lt;func: aarch64@0x434358&amp;gt;
syscall: 0x42 @ func: &amp;lt;func: aarch64@0x434388&amp;gt;
syscall: 0x39 @ func: &amp;lt;func: aarch64@0x4343a0&amp;gt;
syscall: 0x3e @ func: &amp;lt;func: aarch64@0x4343e8&amp;gt;
syscall: 0x84 @ func: &amp;lt;func: aarch64@0x434400&amp;gt;
syscall: 0x51 @ func: &amp;lt;func: aarch64@0x434418&amp;gt;
syscall: 0x92 @ func: &amp;lt;func: aarch64@0x434430&amp;gt;
syscall: 0xde @ func: &amp;lt;func: aarch64@0x434448&amp;gt;
syscall: 0xa7 @ func: &amp;lt;func: aarch64@0x434460&amp;gt;
syscall: 0x60 @ func: &amp;lt;func: aarch64@0x434490&amp;gt;
syscall: 0xe2 @ func: &amp;lt;func: aarch64@0x4344a8&amp;gt;
syscall: 0xd7 @ func: &amp;lt;func: aarch64@0x4344c0&amp;gt;
syscall: 0x5b @ func: &amp;lt;func: aarch64@0x4344f0&amp;gt;
syscall: 0x38 @ func: &amp;lt;func: aarch64@0x434508&amp;gt;
syscall: 0x77 @ func: &amp;lt;func: aarch64@0x434550&amp;gt;
syscall: 0x49 @ func: &amp;lt;func: aarch64@0x434568&amp;gt;
syscall: 0xa6 @ func: &amp;lt;func: aarch64@0x434580&amp;gt;
syscall: 0xac @ func: &amp;lt;func: aarch64@0x439fec&amp;gt;
syscall: 0xce @ func: &amp;lt;func: aarch64@0x43a0a8&amp;gt;
syscall: 0x1d @ func: &amp;lt;func: aarch64@0x43ea1c&amp;gt;
syscall: 0xdc @ func: &amp;lt;func: aarch64@0x449760&amp;gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h5 id=&quot;the-ninja-way&quot;&gt;The Ninja Way&lt;/h5&gt;

&lt;p&gt;Ok so, the above code was pretty sloppy thanks to a lack of sleep, and with some time spent in the &lt;code class=&quot;highlighter-rouge&quot;&gt;Binary Ninja Slack Channel&lt;/code&gt; today, Peter was able to squash some bugs having to do with the &lt;code class=&quot;highlighter-rouge&quot;&gt;get_reg_value_at_low_level_il_instruction&lt;/code&gt; function and assist in getting a way cleaner version of this decode syscall done. The following uses the very powerful &lt;strong&gt;Binary Ninja Low-Level Intermediate Language (LLIL)&lt;/strong&gt; and makes me super excited, because it has replaced hours of work with only a few lines of code:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;bv.functions[65].low_level_il[1]
&amp;gt;&amp;gt;&amp;gt; &amp;lt;il: syscall&amp;gt;

syscall = bv.functions[65].low_level_il[1]

bv.functions[65].get_reg_value_at_low_level_il_instruction(syscall.address, &quot;x8&quot;)
&amp;gt;&amp;gt;&amp;gt; &amp;lt;const 0xae&amp;gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;The &lt;code class=&quot;highlighter-rouge&quot;&gt;bv.functions[65].low_level_il&lt;/code&gt; looks like this:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;x8 = 0xae
syscall
add.q{*}(x0, 1 &amp;lt;&amp;lt; 0xc)
unimplemented
if (u&amp;gt;) then 6 @ 0x42b4b8 else 22 @ 0x43427c
goto 22 @ 0x43427c
sp = sp - 0x20
[sp] = x29
[sp + 8] = x30
x29 = sp
[sp + 0x10] = x19
w19 = w0
call(0x428de8)
x1 = x0
x0 = -1
[x1 + 0].q = w19
x19 = [sp + 0x10].q
x29 = [sp].q
x30 = [8 + sp].q
sp = sp + 0x20
&amp;lt;return&amp;gt; jump(x30)
jump(0x42b4e4)
&amp;lt;return&amp;gt; jump(x30)
jump(0x434280)
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;and in the UI like this:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/Screen Shot 2016-03-12 at 1.10.38 PM.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;The gist of this is basically &lt;code class=&quot;highlighter-rouge&quot;&gt;bv.functions[65]&lt;/code&gt; is a function I know has a &lt;code class=&quot;highlighter-rouge&quot;&gt;syscall&lt;/code&gt;, the &lt;code class=&quot;highlighter-rouge&quot;&gt;.low_level_il&lt;/code&gt; points to the &lt;code class=&quot;highlighter-rouge&quot;&gt;LowLevelILFunction&lt;/code&gt; instance and &lt;code class=&quot;highlighter-rouge&quot;&gt;[1]&lt;/code&gt; tells it to give me the 2nd element in the instance. Setting that to &lt;code class=&quot;highlighter-rouge&quot;&gt;syscall&lt;/code&gt; and calling &lt;code class=&quot;highlighter-rouge&quot;&gt;get_reg_value_at_low_level_il_instruction&lt;/code&gt; allows me to pass it the &lt;code class=&quot;highlighter-rouge&quot;&gt;address&lt;/code&gt; of that syscall IL instance and tell it what register I am interested in &lt;code class=&quot;highlighter-rouge&quot;&gt;x8&lt;/code&gt;. You can check all available registers by using: &lt;code class=&quot;highlighter-rouge&quot;&gt;bv.arch.regs&lt;/code&gt;.&lt;/p&gt;

&lt;h4 id=&quot;lookup-value-to-identify-the-syscall&quot;&gt;Lookup value to identify the &lt;code class=&quot;highlighter-rouge&quot;&gt;syscall&lt;/code&gt;&lt;/h4&gt;

&lt;p&gt;Now that we have the &lt;code class=&quot;highlighter-rouge&quot;&gt;&amp;lt;immediate&amp;gt;&lt;/code&gt; we can do a look-up to enumerate which &lt;code class=&quot;highlighter-rouge&quot;&gt;syscall&lt;/code&gt; it belongs to. The quick-and-dirty way is to just browse to &lt;a href=&quot;http://syscalls.kernelgrok.com/&quot;&gt;syscalls.kernelgrok.com&lt;/a&gt; and look it up manually.  I’m going to work on cleaning up this code and make it an actual &lt;strong&gt;Binary Ninja Plug-in&lt;/strong&gt;, should be uploaded &lt;a href=&quot;https://github.com/ARMNinja&quot;&gt;here&lt;/a&gt; in the next few days. Binary Ninja is still in &lt;code class=&quot;highlighter-rouge&quot;&gt;BETA&lt;/code&gt; so I don’t feel too rushed to get it out. Any questions as always, &lt;a href=&quot;https://www.twitter.com/theqlabs&quot;&gt;tweet&lt;/a&gt; me up!&lt;/p&gt;

&lt;p&gt;Thanks for reading.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;@theqlabs&lt;/strong&gt;&lt;/p&gt;

</content>
 </entry>
 
 <entry>
   <title>Decoding Syscalls in ARM64</title>
   <link href="http://arm.ninja/2016/03/07/decoding-syscalls-in-arm64/"/>
   <updated>2016-03-07T00:00:00-08:00</updated>
   <id>http://arm.ninja/2016/03/07/decoding-syscalls-in-arm64</id>
   <content type="html">&lt;p&gt;Eventually as you are reverse-engineering an &lt;code class=&quot;highlighter-rouge&quot;&gt;ARM&lt;/code&gt; binary you will come across a function that looks like the following:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/Screen Shot 2016-03-06 at 10.26.42 PM.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Even if you understand what this code is doing (as I suspect you may) read on, as this post intends to bring to light several security models specific to the &lt;code class=&quot;highlighter-rouge&quot;&gt;ARMv8-a&lt;/code&gt; architecture.&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;To understand what this code is doing, you need to understand a few concepts first. Since this is an &lt;code class=&quot;highlighter-rouge&quot;&gt;ARM&lt;/code&gt; specific blog, this is what we will focus on. Specifically in the context of the &lt;code class=&quot;highlighter-rouge&quot;&gt;ARMv8-a&lt;/code&gt; architecture. An extremely helpful overview of this architecture can be found &lt;a href=&quot;https://quequero.org/2014/04/introduction-to-arm-architecture/&quot;&gt;here&lt;/a&gt; - I suggest you read it before continuing.&lt;/p&gt;

&lt;h3 id=&quot;exception-levels&quot;&gt;Exception Levels&lt;/h3&gt;

&lt;p&gt;The most important concept is rather new, these are the &lt;strong&gt;Exception Levels&lt;/strong&gt; &lt;code class=&quot;highlighter-rouge&quot;&gt;ARMv8-a&lt;/code&gt; uses for privilege separation (such as &lt;code class=&quot;highlighter-rouge&quot;&gt;rings&lt;/code&gt; in the &lt;code class=&quot;highlighter-rouge&quot;&gt;Intel&lt;/code&gt; architecture) there are 4 levels, notably:&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;Exception Level&lt;/th&gt;
      &lt;th&gt;Description&lt;/th&gt;
      &lt;th&gt;Usage*&lt;/th&gt;
      &lt;th&gt;Status&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;&lt;strong&gt;EL0&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;Unprivileged&lt;/td&gt;
      &lt;td&gt;Applications are executed here&lt;/td&gt;
      &lt;td&gt;Required&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;&lt;strong&gt;EL1&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;Privileged&lt;/td&gt;
      &lt;td&gt;Linux (or other OS) Kernel&lt;/td&gt;
      &lt;td&gt;Required&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;&lt;strong&gt;EL2&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;Hypervisor&lt;/td&gt;
      &lt;td&gt;&lt;em&gt;Virtualization&lt;/em&gt;&lt;/td&gt;
      &lt;td&gt;&lt;em&gt;Optional&lt;/em&gt;&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;&lt;strong&gt;EL3&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;Secure Monitor&lt;/td&gt;
      &lt;td&gt;&lt;em&gt;Security States&lt;/em&gt;&lt;/td&gt;
      &lt;td&gt;&lt;em&gt;Optional&lt;/em&gt;&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;*: &lt;code class=&quot;highlighter-rouge&quot;&gt;aarch64&lt;/code&gt; does not dictate &lt;strong&gt;how&lt;/strong&gt; software can use the exception levels, these are simply a common usage model.&lt;/p&gt;

&lt;p&gt;Now, as you can imagine, applications running in &lt;strong&gt;EL0&lt;/strong&gt; may need to access or modify the system in some way. The Linux kernel provides a &lt;del&gt;safe&lt;/del&gt; portable way to access these system-level functions. This Application Programming Interface or &lt;code class=&quot;highlighter-rouge&quot;&gt;API&lt;/code&gt; between the &lt;em&gt;unprivileged&lt;/em&gt; &lt;strong&gt;EL0&lt;/strong&gt; and the &lt;em&gt;privileged&lt;/em&gt; &lt;strong&gt;EL1&lt;/strong&gt; execution levels are called &lt;strong&gt;system calls&lt;/strong&gt; or &lt;code class=&quot;highlighter-rouge&quot;&gt;syscalls&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;The &lt;code class=&quot;highlighter-rouge&quot;&gt;ARMv8-a&lt;/code&gt; architecture has strict rules about how to leverage &lt;code class=&quot;highlighter-rouge&quot;&gt;syscalls&lt;/code&gt;, as you can imagine abuse of this &lt;code class=&quot;highlighter-rouge&quot;&gt;API&lt;/code&gt; is commmon and could lead to an &lt;em&gt;unprivileged&lt;/em&gt; application modifying the system beyond what it should be allowed to. This technique has been used countless times to gain &lt;code class=&quot;highlighter-rouge&quot;&gt;root&lt;/code&gt; on a device or escalate privileges of a user. One of the biggest issues with mobile devices is there is not much quality control for software that interfaces with the kernel, things like device drivers get abused far too often.&lt;/p&gt;

&lt;p&gt;Before we get into exceptions, it should be noted that &lt;code class=&quot;highlighter-rouge&quot;&gt;ARMv8-a&lt;/code&gt; has a (harrowingly complicated) &lt;strong&gt;Security Model&lt;/strong&gt;, whose general principles are as follows. If &lt;strong&gt;EL3&lt;/strong&gt; is implemented in the system there are two &lt;code class=&quot;highlighter-rouge&quot;&gt;security states&lt;/code&gt; &lt;strong&gt;Secure&lt;/strong&gt; and &lt;strong&gt;Non-Secure&lt;/strong&gt; each with their own physical memory address space. If &lt;strong&gt;EL3&lt;/strong&gt; is not implemented, &lt;strong&gt;AND&lt;/strong&gt; does not include &lt;strong&gt;EL2&lt;/strong&gt; then it’s &lt;code class=&quot;highlighter-rouge&quot;&gt;IMPLEMENTATION DEFINED&lt;/code&gt;. If &lt;strong&gt;EL2&lt;/strong&gt; is present then it is Non-Secure state. Changing states occurs in the same fashion as the exceptions described below.&lt;/p&gt;

&lt;h3 id=&quot;exceptions&quot;&gt;Exceptions&lt;/h3&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;ARMv8-a&lt;/code&gt; can operate in two &lt;code class=&quot;highlighter-rouge&quot;&gt;execution states&lt;/code&gt; &lt;code class=&quot;highlighter-rouge&quot;&gt;Aarch64&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;Aarch32&lt;/code&gt; (compatible with &lt;code class=&quot;highlighter-rouge&quot;&gt;ARMv7-a&lt;/code&gt;). It is possible to move between these two states using what the architecture defines as &lt;code class=&quot;highlighter-rouge&quot;&gt;interprocessing&lt;/code&gt; though it is not useful for this exercise.&lt;/p&gt;

&lt;p&gt;In &lt;code class=&quot;highlighter-rouge&quot;&gt;Aarch64&lt;/code&gt; state, you can change exception levels only by taking an exception, or returning from one. Perhaps the best way to explain it is with pseudo-code:&lt;/p&gt;

&lt;h4 id=&quot;bit&quot;&gt;64-bit:&lt;/h4&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;if state == aarch64 &amp;amp;&amp;amp; take_exception {
	 target_exception_level = exception_level or exception_level+1
}

if state == aarch64 &amp;amp;&amp;amp; return_from_exception {
	target_exception_level = exception_level or exception_level-1
}
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;There are a few types of exceptions &lt;code class=&quot;highlighter-rouge&quot;&gt;ARMv8-a&lt;/code&gt; allows that will interrupt the processor and change the control flow of the program. These are:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;SVC&lt;/code&gt; Supervisor Call attempts to access &lt;strong&gt;EL1&lt;/strong&gt; from &lt;strong&gt;EL0&lt;/strong&gt;.&lt;/li&gt;
  &lt;li&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;HVC&lt;/code&gt; Hypervisor Call attempts to access &lt;strong&gt;EL2&lt;/strong&gt;&lt;/li&gt;
  &lt;li&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;SMC&lt;/code&gt; Secure Monitor Call attempts to access &lt;strong&gt;EL3&lt;/strong&gt;&lt;/li&gt;
  &lt;li&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;HLT&lt;/code&gt; Halting Software Breakpoint Instruction&lt;/li&gt;
  &lt;li&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;BRK&lt;/code&gt; Software Breakpoint Instruction&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;The &lt;code class=&quot;highlighter-rouge&quot;&gt;SVC&lt;/code&gt; instruction is the most common, and the one we are dealing with in the following example. This instruction causes a Supervisor Call exception, which provides this &lt;em&gt;unprivileged&lt;/em&gt; program the ability to make a system call to the &lt;em&gt;privileged&lt;/em&gt; operating system. When &lt;code class=&quot;highlighter-rouge&quot;&gt;SVC&lt;/code&gt; is executed, the &lt;code class=&quot;highlighter-rouge&quot;&gt;target_exception_level&lt;/code&gt; becomes &lt;code class=&quot;highlighter-rouge&quot;&gt;EL1&lt;/code&gt; from &lt;code class=&quot;highlighter-rouge&quot;&gt;EL0&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/Screen Shot 2016-03-06 at 10.26.42 PM.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Let’s walk-through this function to see what’s going on:&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;MOV		X8, #0x40&lt;/code&gt;&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;Moves the immediate value 0x40 into the X8 register.&lt;/p&gt;

&lt;p&gt;While this looks like a simple instruction there’s a lot going on here that you may not be familiar with. Prefacing a call to the kernel (SVC 0) we have to setup that call, which generally means you need two things:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;a system call, defined by a number (in our case 0x40)&lt;/li&gt;
  &lt;li&gt;a register to place the return value (typically X0)&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;It is also important to note, that (quite annoyingly) these syscall numbers change based on the architecture you are executing the instruction. In this case, 0x40 is defined in the arm64 kernel as a call to &lt;strong&gt;write&lt;/strong&gt;. And of course since ARM is a load/store based architecture we require &lt;strong&gt;X8&lt;/strong&gt; to act as a catalyst to move the value since we can not write the value directly to memory (like you can in other architectures.)&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Note: In ARMv7 the R7 register was used, which you can remember by: v7 uses R7, v8 uses X8.&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;SVC		0&lt;/code&gt;&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;Generates supervisor call exception, targeting EL1&lt;/p&gt;

&lt;p&gt;The call looks like this: 
&lt;code class=&quot;highlighter-rouge&quot;&gt;AArch64.TakeException(EL1, exception, preferred_exception_return, vect_offset);&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;Now is a good time to break and talk about what &lt;code class=&quot;highlighter-rouge&quot;&gt;vect_offset&lt;/code&gt; is:&lt;/p&gt;

&lt;hr /&gt;

&lt;h4 id=&quot;exception-vector-tables&quot;&gt;Exception Vector Tables&lt;/h4&gt;

&lt;p&gt;From &lt;a href=&quot;http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.den0024a/CHDEEDDC.html&quot;&gt;ARM Infocenter&lt;/a&gt;:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;When an exception occurs, the processor must execute handler code which corresponds to the exception. The location in memory where the handler is stored is called the exception vector. In the ARM architecture, exception vectors are stored in a table, called the &lt;strong&gt;exception vector table&lt;/strong&gt;. Each Exception level has its own vector table, that is, there is one for each of EL3, EL2 and EL1. The &lt;strong&gt;table contains instructions to be executed&lt;/strong&gt;, rather than a set of addresses. Vectors for individual exceptions are located at fixed offsets from the beginning of the table. The virtual address of each table base is set by the Vector Based Address Registers &lt;code class=&quot;highlighter-rouge&quot;&gt;VBAR_EL3&lt;/code&gt;, &lt;code class=&quot;highlighter-rouge&quot;&gt;VBAR_EL2&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;VBAR_EL1&lt;/code&gt;.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;This means that after &lt;code class=&quot;highlighter-rouge&quot;&gt;SVC 0&lt;/code&gt; is called, &lt;code class=&quot;highlighter-rouge&quot;&gt;AArch64.TakeException()&lt;/code&gt; executes using &lt;code class=&quot;highlighter-rouge&quot;&gt;VBAR_EL1&lt;/code&gt; + &lt;code class=&quot;highlighter-rouge&quot;&gt;vect_offset&lt;/code&gt; &lt;code class=&quot;highlighter-rouge&quot;&gt;0x280&lt;/code&gt; to retrieve the exception handler instructions to carry out the exception - &lt;em&gt;see Table 10.2 in the infocenter reference for information about calculating offsets&lt;/em&gt;.&lt;/p&gt;

&lt;p&gt;Accessing &lt;code class=&quot;highlighter-rouge&quot;&gt;VBAR_EL1&lt;/code&gt; is done through the &lt;code class=&quot;highlighter-rouge&quot;&gt;MRS&lt;/code&gt; instruction and looks like this for our example:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/Screen Shot 2016-03-08 at 12.21.15 AM.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;&lt;strong&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;CMN		X0, #1, LSL#12&lt;/code&gt;&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;CINV	X0, X0, HI&lt;/code&gt;&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;B.HI	loc_42B4B8&lt;/code&gt;&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;ARM has a number of potential conditions set by the 4-bit prefix in an instruction word. The prefix we are intersted in is the &lt;strong&gt;HI&lt;/strong&gt; condition as shown by our instructions. The &lt;strong&gt;HI&lt;/strong&gt; condition is met when the Carry flag is set and the Zero flag is false, which simply means there was a non-zero value returned from the system call into &lt;strong&gt;X0&lt;/strong&gt;.&lt;/p&gt;

&lt;p&gt;The above instructions are checking the returned value from the system call, stored in X0, for a non-zero value (an error) and setting the HI condition to branch accordingly into &lt;strong&gt;loc_42B4B8&lt;/strong&gt;.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/Screen Shot 2016-03-08 at 12.25.02 AM.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;RET&lt;/code&gt;&lt;/strong&gt;&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Branches to the address stored in the Link Register (LR)
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;Now that you understand what is happening with this function it is a good idea to rename it in IDA so that you can identify when a function is calling the &lt;code class=&quot;highlighter-rouge&quot;&gt;sys_getppid&lt;/code&gt; handler!&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/Screen Shot 2016-03-06 at 10.33.07 PM.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/Screen Shot 2016-03-06 at 10.29.19 PM.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;I left some details out about the above process because this was meant as an intro. Some of the topics I did not discuss are &lt;code class=&quot;highlighter-rouge&quot;&gt;Exception Syndrome Registers&lt;/code&gt;, &lt;code class=&quot;highlighter-rouge&quot;&gt;Exception Link Registers&lt;/code&gt;, and &lt;code class=&quot;highlighter-rouge&quot;&gt;PSTATE&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;NOTE: To learn more about exceptions in &lt;code class=&quot;highlighter-rouge&quot;&gt;ARMv8-a&lt;/code&gt; check out &lt;code class=&quot;highlighter-rouge&quot;&gt;Chapter D1&lt;/code&gt; in the &lt;code class=&quot;highlighter-rouge&quot;&gt;Aarch64 Reference Manual&lt;/code&gt;&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;A great tip by @michalmalik to use the &lt;code class=&quot;highlighter-rouge&quot;&gt;man&lt;/code&gt; pages to reference &lt;a href=&quot;http://man7.org/linux/man-pages/man2/syscall.2.html&quot;&gt;Architecture Calling Conventions&lt;/a&gt; in case you forget what registers are used. Thanks Michal!&lt;/p&gt;

</content>
 </entry>
 
 <entry>
   <title>Reverse Engineering Samsung S6 Modem</title>
   <link href="http://arm.ninja/2016/03/04/reverse-engineering-samsung-s6-modem/"/>
   <updated>2016-03-04T00:00:00-08:00</updated>
   <id>http://arm.ninja/2016/03/04/reverse-engineering-samsung-s6-modem</id>
   <content type="html">&lt;p&gt;So I was a little late to the game, and just got my hands on a Samsung Galaxy S6, specifically the &lt;code class=&quot;highlighter-rouge&quot;&gt;SM-G920F&lt;/code&gt; which will be the topic of discussion in this post. I am quite curious as to understanding the structure of the device’s &lt;code class=&quot;highlighter-rouge&quot;&gt;modem.bin&lt;/code&gt; file. While I haven’t been able to get a de-obfuscated/decrypted version of &lt;code class=&quot;highlighter-rouge&quot;&gt;modem.bin&lt;/code&gt; yet, hopefully this post will help others quickly get up-to-speed and assist in the pursuit of one.&lt;/p&gt;

&lt;h1 id=&quot;obtaining-files&quot;&gt;Obtaining Files&lt;/h1&gt;
&lt;ul&gt;
  &lt;li&gt;Download &lt;strong&gt;Samsung&lt;/strong&gt; &lt;a href=&quot;http://www.sammobile.com&quot;&gt;SM-G920F&lt;/a&gt; &lt;strong&gt;Galaxy S6&lt;/strong&gt; Firmware&lt;/li&gt;
&lt;/ul&gt;

&lt;h1 id=&quot;extracting-files&quot;&gt;Extracting Files&lt;/h1&gt;
&lt;p&gt;I had some issues using &lt;code class=&quot;highlighter-rouge&quot;&gt;UnZip 5.52&lt;/code&gt; on OS X (PK compat. error), so instead I used &lt;code class=&quot;highlighter-rouge&quot;&gt;UnZip 6.00&lt;/code&gt; on Ubuntu 15.04.&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;unzip &amp;lt;firmware.zip&amp;gt;
mv &amp;lt;firmware.tar.md5&amp;gt; &amp;lt;firmware.tar&amp;gt;
tar xvf &amp;lt;firmware.tar&amp;gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;You should end up with something like:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;boot.img
cache.img
cm.bin
hidden.img
modem.bin
recovery.img
sboot.bin
system.img
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h1 id=&quot;deconstructing-modembin&quot;&gt;Deconstructing &lt;code class=&quot;highlighter-rouge&quot;&gt;modem.bin&lt;/code&gt;&lt;/h1&gt;

&lt;p&gt;&lt;strong&gt;Endianness&lt;/strong&gt;: Most of what we will be seeing in &lt;code class=&quot;highlighter-rouge&quot;&gt;modem.bin&lt;/code&gt; is comprised of Little-Endian format. That is, the Most Significant Byte is located at the highest memory address. &lt;strong&gt;Example&lt;/strong&gt;: If you look at &lt;code class=&quot;highlighter-rouge&quot;&gt;SIZE&lt;/code&gt; of &lt;code class=&quot;highlighter-rouge&quot;&gt;BOOT&lt;/code&gt; below, the bytes are ordered as &lt;code class=&quot;highlighter-rouge&quot;&gt;48 2B 00 00&lt;/code&gt; but read and sent as &lt;code class=&quot;highlighter-rouge&quot;&gt;0x2B48&lt;/code&gt; dropping the &lt;code class=&quot;highlighter-rouge&quot;&gt;00&lt;/code&gt;s as you would in decimal for anything before a non-zero number.&lt;/p&gt;

&lt;h3 id=&quot;toc0--toc&quot;&gt;TOC[0] = TOC&lt;/h3&gt;

&lt;p&gt;Opening &lt;code class=&quot;highlighter-rouge&quot;&gt;modem.bin&lt;/code&gt; in a Hex Editor gives some immediate insight into what is happening with this file.&lt;/p&gt;

&lt;p&gt;The first &lt;code class=&quot;highlighter-rouge&quot;&gt;0x200&lt;/code&gt; bytes are called the &lt;code class=&quot;highlighter-rouge&quot;&gt;TOC&lt;/code&gt;, I am going to make a slightly ambitious guess that this stands for &lt;code class=&quot;highlighter-rouge&quot;&gt;Table of Contents&lt;/code&gt;. Its function is to provide information about the file itself including all [5] of its sections, namely: &lt;code class=&quot;highlighter-rouge&quot;&gt;TOC&lt;/code&gt;, &lt;code class=&quot;highlighter-rouge&quot;&gt;BOOT&lt;/code&gt;, &lt;code class=&quot;highlighter-rouge&quot;&gt;MAIN&lt;/code&gt;, &lt;code class=&quot;highlighter-rouge&quot;&gt;NV&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;OFFSET&lt;/code&gt;, as well as providing an index into these sections.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/Screen Shot 2016-02-29 at 3.22.21 PM.png&quot; alt=&quot;header&quot; /&gt;&lt;/p&gt;

&lt;p&gt;While the above screen shot shows only addresses &lt;code class=&quot;highlighter-rouge&quot;&gt;0000h-0090h&lt;/code&gt; the remaining bytes are all zero-padded &lt;code class=&quot;highlighter-rouge&quot;&gt;0x200&lt;/code&gt; bytes in total.&lt;/p&gt;

&lt;h3 id=&quot;toc1--boot&quot;&gt;TOC[1] = BOOT&lt;/h3&gt;

&lt;p&gt;If you want to isolate the &lt;code class=&quot;highlighter-rouge&quot;&gt;BOOT&lt;/code&gt; section of the file you would do so by calculating the offsets based on the &lt;code class=&quot;highlighter-rouge&quot;&gt;SIZE&lt;/code&gt; parameter from the header file. So for our example it would look like the following:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;dd if=modem.bin bs=1 skip=512 count=11080 of=modem.bin_boot

# calculated by using the 0x200 byte offset in decimal.
skip=512
 
# calculated by using the 0x2B48 byte SIZE of BOOT in decimal.
count=11080
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/assets/Screen Shot 2016-02-29 at 4.51.03 PM.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;Address&lt;/th&gt;
      &lt;th&gt;Bytes&lt;/th&gt;
      &lt;th&gt;Length&lt;/th&gt;
      &lt;th&gt;Description&lt;/th&gt;
      &lt;th&gt;Value&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;0020&lt;/code&gt;-&lt;code class=&quot;highlighter-rouge&quot;&gt;002C&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;&lt;strong&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;42 4F 4F 54&lt;/code&gt;&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;12 Bytes&lt;/td&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;NAME&lt;/code&gt; of Section&lt;/td&gt;
      &lt;td&gt;BOOT&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;002C&lt;/code&gt;-&lt;code class=&quot;highlighter-rouge&quot;&gt;0030&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;&lt;strong&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;00 02 00 00&lt;/code&gt;&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;4 Bytes&lt;/td&gt;
      &lt;td&gt;Unknown&lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;0030&lt;/code&gt;-&lt;code class=&quot;highlighter-rouge&quot;&gt;0034&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;&lt;strong&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;00 00 00 00&lt;/code&gt;&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;4 Bytes&lt;/td&gt;
      &lt;td&gt;Unknown&lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;0034&lt;/code&gt;-&lt;code class=&quot;highlighter-rouge&quot;&gt;0038&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;&lt;strong&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;48 2B 00 00&lt;/code&gt;&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;4 Bytes&lt;/td&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;SIZE&lt;/code&gt; of &lt;code class=&quot;highlighter-rouge&quot;&gt;BOOT&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;0x2B48&lt;/code&gt; bytes&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;0038&lt;/code&gt;-&lt;code class=&quot;highlighter-rouge&quot;&gt;003C&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;&lt;strong&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;45 03 27 5E&lt;/code&gt;&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;4 Bytes&lt;/td&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;CRC&lt;/code&gt; of &lt;code class=&quot;highlighter-rouge&quot;&gt;BOOT&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;0x5E270345&lt;/code&gt;&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;003C&lt;/code&gt;-&lt;code class=&quot;highlighter-rouge&quot;&gt;0040&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;&lt;strong&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;00 00 00 00&lt;/code&gt;&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;4 Bytes&lt;/td&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;INDEX&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;Index into &lt;code class=&quot;highlighter-rouge&quot;&gt;TOC&lt;/code&gt;&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;h3 id=&quot;toc2--main&quot;&gt;TOC[2] = MAIN&lt;/h3&gt;
&lt;p&gt;Similar to &lt;code class=&quot;highlighter-rouge&quot;&gt;BOOT&lt;/code&gt; you would isolate &lt;code class=&quot;highlighter-rouge&quot;&gt;MAIN&lt;/code&gt; with the following &lt;code class=&quot;highlighter-rouge&quot;&gt;dd&lt;/code&gt; command:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;dd if=modem.bin bs=1 skip=11592 count=40394816 of=modem.bin_main
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/assets/Screen Shot 2016-02-29 at 3.21.20 PM.png&quot; alt=&quot;MAIN&quot; /&gt;&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;Address&lt;/th&gt;
      &lt;th&gt;Bytes&lt;/th&gt;
      &lt;th&gt;Length&lt;/th&gt;
      &lt;th&gt;Description&lt;/th&gt;
      &lt;th&gt;Value&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;0040&lt;/code&gt; - &lt;code class=&quot;highlighter-rouge&quot;&gt;004C&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;&lt;strong&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;4D 41 49 4E&lt;/code&gt;&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;12 Bytes&lt;/td&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;NAME&lt;/code&gt; of Section&lt;/td&gt;
      &lt;td&gt;MAIN&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;004C&lt;/code&gt; - &lt;code class=&quot;highlighter-rouge&quot;&gt;0050&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;&lt;strong&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;60 2D 00 00&lt;/code&gt;&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;4 Bytes&lt;/td&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;VERSION&lt;/code&gt;*&lt;/td&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;0x2D60&lt;/code&gt; 1.16.16&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;0050&lt;/code&gt; - &lt;code class=&quot;highlighter-rouge&quot;&gt;0054&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;&lt;strong&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;00 00 00 40&lt;/code&gt;&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;4 Bytes&lt;/td&gt;
      &lt;td&gt;Unknown&lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;0054&lt;/code&gt; - &lt;code class=&quot;highlighter-rouge&quot;&gt;0058&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;&lt;strong&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;40 60 68 02&lt;/code&gt;&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;4 Bytes&lt;/td&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;SIZE&lt;/code&gt; of &lt;code class=&quot;highlighter-rouge&quot;&gt;MAIN&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;0x2686040&lt;/code&gt; or 40,394,816 bytes or ~40MB&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;0058&lt;/code&gt; - &lt;code class=&quot;highlighter-rouge&quot;&gt;005C&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;&lt;strong&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;24 BD DF 93&lt;/code&gt;&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;4 Bytes&lt;/td&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;CRC&lt;/code&gt; of &lt;code class=&quot;highlighter-rouge&quot;&gt;MAIN&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;0x93DFBD24&lt;/code&gt;&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;005C&lt;/code&gt; - &lt;code class=&quot;highlighter-rouge&quot;&gt;0060&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;&lt;strong&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;02 00 00 00&lt;/code&gt;&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;4 Bytes&lt;/td&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;INDEX&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;Has to do with index into &lt;code class=&quot;highlighter-rouge&quot;&gt;TOC&lt;/code&gt;&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;*&lt;/code&gt; - &lt;code class=&quot;highlighter-rouge&quot;&gt;VERSION&lt;/code&gt; is a guess based on analyzing multiple firmwares, seen both &lt;code class=&quot;highlighter-rouge&quot;&gt;0x2D00&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;0x2D60&lt;/code&gt;. Will confirm, should be able to reverse &lt;code class=&quot;highlighter-rouge&quot;&gt;cbd&lt;/code&gt; &lt;code class=&quot;highlighter-rouge&quot;&gt;prepare_boot_args&lt;/code&gt; or related functions to ensure the above is correct.&lt;/p&gt;

&lt;h3 id=&quot;toc3--nv&quot;&gt;TOC[3] = NV&lt;/h3&gt;

&lt;p&gt;&lt;img src=&quot;/assets/Screen Shot 2016-03-01 at 12.29.54 AM.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;Address&lt;/th&gt;
      &lt;th&gt;Bytes&lt;/th&gt;
      &lt;th&gt;Length&lt;/th&gt;
      &lt;th&gt;Description&lt;/th&gt;
      &lt;th&gt;Value&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;0060&lt;/code&gt; - &lt;code class=&quot;highlighter-rouge&quot;&gt;006C&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;&lt;strong&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;4E 56 00 00&lt;/code&gt;&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;12 Bytes&lt;/td&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;NAME&lt;/code&gt; of Section&lt;/td&gt;
      &lt;td&gt;NV&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;006C&lt;/code&gt; - &lt;code class=&quot;highlighter-rouge&quot;&gt;0070&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;&lt;strong&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;00 00 00 00&lt;/code&gt;&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;4 Bytes&lt;/td&gt;
      &lt;td&gt;Unknown&lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;0070&lt;/code&gt; - &lt;code class=&quot;highlighter-rouge&quot;&gt;0074&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;&lt;strong&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;00 00 EE 47&lt;/code&gt;&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;4 Bytes&lt;/td&gt;
      &lt;td&gt;Unknown&lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;0074&lt;/code&gt; - &lt;code class=&quot;highlighter-rouge&quot;&gt;0078&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;&lt;strong&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;00 00 10 00&lt;/code&gt;&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;4 Bytes&lt;/td&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;SIZE&lt;/code&gt; of &lt;code class=&quot;highlighter-rouge&quot;&gt;NV&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;0x2B48&lt;/code&gt; bytes&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;0078&lt;/code&gt; - &lt;code class=&quot;highlighter-rouge&quot;&gt;007C&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;&lt;strong&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;00 00 00 00&lt;/code&gt;&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;4 Bytes&lt;/td&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;CRC&lt;/code&gt; of &lt;code class=&quot;highlighter-rouge&quot;&gt;NV&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;N/A&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;007C&lt;/code&gt; - &lt;code class=&quot;highlighter-rouge&quot;&gt;0080&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;&lt;strong&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;03 00 00 00&lt;/code&gt;&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;4 Bytes&lt;/td&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;INDEX&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;Has to do with index into &lt;code class=&quot;highlighter-rouge&quot;&gt;TOC&lt;/code&gt;&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;h3 id=&quot;toc4--offset&quot;&gt;TOC[4] = OFFSET&lt;/h3&gt;
&lt;p&gt;I have never seen &lt;code class=&quot;highlighter-rouge&quot;&gt;cbd&lt;/code&gt; process or send this section, so I’m assuming its use is local to the &lt;code class=&quot;highlighter-rouge&quot;&gt;modem.bin&lt;/code&gt; file and not to the CP. Perhaps the &lt;code class=&quot;highlighter-rouge&quot;&gt;BOOT&lt;/code&gt; is using it in some way?&lt;/p&gt;

&lt;h1 id=&quot;decoding-boot&quot;&gt;Decoding &lt;code class=&quot;highlighter-rouge&quot;&gt;BOOT&lt;/code&gt;&lt;/h1&gt;
&lt;p&gt;So you may have noticed some patterns while looking at the &lt;code class=&quot;highlighter-rouge&quot;&gt;BOOT&lt;/code&gt; code, in our example located from &lt;code class=&quot;highlighter-rouge&quot;&gt;0200-02D48h&lt;/code&gt; and in case you didn’t I’m going to show you a trick I learned from the &lt;strong&gt;Practical Reverse Engineering&lt;/strong&gt; &lt;a href=&quot;http://smile.amazon.com/dp/1118787315&quot;&gt;book&lt;/a&gt; by Dang et al. As they so correctly state:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;The ability to recognize instruction boundaries in a seemingly random blob of data is important. Maybe you will appreciate it later.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Also, say &lt;strong&gt;Dang et al.&lt;/strong&gt; out loud. Ha!&lt;/p&gt;

&lt;p&gt;Let’s review a chunk of &lt;code class=&quot;highlighter-rouge&quot;&gt;BOOT&lt;/code&gt;:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/Screen Shot 2016-02-29 at 8.41.40 PM.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;TL;DR&lt;/strong&gt; - These are ARM instructions and we’re about to disassemble the sh*t out of them.&lt;/p&gt;

&lt;p&gt;Looking at this blob, it’s easy to notice a pattern. Almost every &lt;code class=&quot;highlighter-rouge&quot;&gt;4th byte&lt;/code&gt; ends in &lt;code class=&quot;highlighter-rouge&quot;&gt;0xE*&lt;/code&gt; - as it turns out, ARM branch instructions use the Most Significant Bits for a conditional code. These &lt;a href=&quot;http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.dui0204j/Chdhcfbc.html&quot;&gt;codes&lt;/a&gt; control the execution of instructions and are typically based on the flags set in the &lt;a href=&quot;http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.ddi0413d/ch02s02s02.html&quot;&gt;Application Program Status Registers&lt;/a&gt; or &lt;code class=&quot;highlighter-rouge&quot;&gt;APSR&lt;/code&gt;. So if you want to tell an instruction to Always Execute, you would use the &lt;code class=&quot;highlighter-rouge&quot;&gt;AL&lt;/code&gt; condition which is &lt;code class=&quot;highlighter-rouge&quot;&gt;1110b&lt;/code&gt; or &lt;code class=&quot;highlighter-rouge&quot;&gt;0xE&lt;/code&gt;. If you have any experience with crackmes this is analogous to switching the &lt;code class=&quot;highlighter-rouge&quot;&gt;Z&lt;/code&gt; or Zero Flag when you wanted to alter the state of a conditional JMP (x86) or B (ARM).&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;TODO&lt;/strong&gt;: Reversing &lt;code class=&quot;highlighter-rouge&quot;&gt;BOOT&lt;/code&gt; will be part of a later post.&lt;/p&gt;

&lt;h1 id=&quot;cp-boot-process&quot;&gt;CP Boot Process&lt;/h1&gt;
&lt;p&gt;The following is what I know based on crashing the modem many times, reversing &lt;code class=&quot;highlighter-rouge&quot;&gt;cbd&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;BOOT&lt;/code&gt;&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;cbd	 # CP Boot Daemon lives in /sbin on the device
CP 	 # Cell Processor or Modem
AP	 # Application Processor, where Android OS lives
BOOT	 # BOOT section of the modem.bin
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h3 id=&quot;devumtsboot0&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;/dev/umts_boot0&lt;/code&gt;&lt;/h3&gt;
&lt;p&gt;Opened by &lt;code class=&quot;highlighter-rouge&quot;&gt;rild&lt;/code&gt; used for most I/O involving CP boot chain.&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;misc_ioctl:
	IOCTL_MODEM_ON
	IOCTL_MODEM_BOOT_ON
	IOCTL_MODEM_DL_START	 # Starts `mem_start_download`
	IOCTL_MODEM_SET_TX_LINK	 # Sets Boot Link / Main Link
	IOCTL_MODEM_FW_UPDATE	 # Called after stages are sent to CP
	IOCTL_MODEM_BOOT_OFF	 # Sent after Stage 3 is sent to CP
	IOCTL_MODEM_BOOT_DONE	 # Final IOCTL for CP boot chain
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h3 id=&quot;startshannon333boot&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;start_shannon333_boot&lt;/code&gt;&lt;/h3&gt;
&lt;p&gt;…&lt;/p&gt;

&lt;h3 id=&quot;shannonnormalboot&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;shannon_normal_boot&lt;/code&gt;&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;LLI STATUS mount&lt;/code&gt;&lt;/p&gt;

&lt;h3 id=&quot;preparebootargs&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;prepare_boot_args&lt;/code&gt;&lt;/h3&gt;
&lt;p&gt;…&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/Screen Shot 2016-02-28 at 2.21.46 PM.png&quot; alt=&quot;dmsg&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;memstartdownload&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;mem_start_download&lt;/code&gt;&lt;/h3&gt;
&lt;p&gt;Triggered by &lt;code class=&quot;highlighter-rouge&quot;&gt;IOCTL_MODEM_DL_START&lt;/code&gt; which grabs the &lt;code class=&quot;highlighter-rouge&quot;&gt;BOOT&lt;/code&gt; section of &lt;code class=&quot;highlighter-rouge&quot;&gt;modem.bin&lt;/code&gt; and sends it to the CP to start the boot code. The code appears to come from &lt;code class=&quot;highlighter-rouge&quot;&gt;link_device_bootdump.c&lt;/code&gt; in the Android kernel.&lt;/p&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;magic == 0x424F4F54&lt;/code&gt; or &lt;code class=&quot;highlighter-rouge&quot;&gt;BOOT&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/Screen Shot 2016-02-29 at 4.38.10 PM.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;stddlsendbin&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;std_dl_send_bin&lt;/code&gt;&lt;/h3&gt;

&lt;p&gt;Sends parsed &lt;code class=&quot;highlighter-rouge&quot;&gt;modem.bin&lt;/code&gt; to CP RAM via &lt;code class=&quot;highlighter-rouge&quot;&gt;BOOT&lt;/code&gt; code. I’m thinking the &lt;code class=&quot;highlighter-rouge&quot;&gt;CMD=&lt;/code&gt; are private IOCTL command IDs.&lt;/p&gt;

&lt;h4 id=&quot;stage-1-0x200-bytes-header&quot;&gt;Stage 1: &lt;code class=&quot;highlighter-rouge&quot;&gt;0x200&lt;/code&gt; bytes header&lt;/h4&gt;
&lt;p&gt;&lt;img src=&quot;/assets/Screen Shot 2016-02-29 at 11.48.04 PM.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;h4 id=&quot;stage-2-0x2686040-bytes-main&quot;&gt;Stage 2: &lt;code class=&quot;highlighter-rouge&quot;&gt;0x2686040&lt;/code&gt; bytes &lt;code class=&quot;highlighter-rouge&quot;&gt;MAIN&lt;/code&gt;&lt;/h4&gt;
&lt;p&gt;&lt;img src=&quot;/assets/Screen Shot 2016-02-29 at 11.48.20 PM.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;h4 id=&quot;checks-crc-for-main&quot;&gt;Checks &lt;code class=&quot;highlighter-rouge&quot;&gt;CRC&lt;/code&gt; for &lt;code class=&quot;highlighter-rouge&quot;&gt;MAIN&lt;/code&gt;&lt;/h4&gt;
&lt;p&gt;I’m guessing it sends the &lt;code class=&quot;highlighter-rouge&quot;&gt;MAIN&lt;/code&gt; &lt;code class=&quot;highlighter-rouge&quot;&gt;CRC&lt;/code&gt; to the &lt;code class=&quot;highlighter-rouge&quot;&gt;BOOT&lt;/code&gt; code to verify&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/Screen Shot 2016-02-11 at 8.40.31 PM.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;h4 id=&quot;stage-3-0x100000-bytes-of-nvram&quot;&gt;Stage 3: &lt;code class=&quot;highlighter-rouge&quot;&gt;0x100000&lt;/code&gt; bytes of &lt;code class=&quot;highlighter-rouge&quot;&gt;NVRAM&lt;/code&gt;&lt;/h4&gt;
&lt;p&gt;&lt;img src=&quot;/assets/Screen Shot 2016-03-01 at 12.02.43 AM.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;checkfactorylogpath&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;check_factory_log_path&lt;/code&gt;&lt;/h3&gt;
&lt;p&gt;Set to &lt;code class=&quot;highlighter-rouge&quot;&gt;/sdcard/log&lt;/code&gt;/ annoyingly the &lt;code class=&quot;highlighter-rouge&quot;&gt;SM-G920F&lt;/code&gt; does not have an SD CARD slot so uses a shitty Virtual SD daemon that does not appear to work correctly because I can not get anything saved into the directory. Will work on a way to set this, should be fairly simple.&lt;/p&gt;

&lt;h3 id=&quot;stdudlreqresp&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;std_udl_req_resp&lt;/code&gt;&lt;/h3&gt;
&lt;p&gt;I’m not sure why &lt;code class=&quot;highlighter-rouge&quot;&gt;cbd&lt;/code&gt; calls these functions, but called before &lt;code class=&quot;highlighter-rouge&quot;&gt;std_dl_send_bin&lt;/code&gt;&lt;/p&gt;

&lt;h1 id=&quot;service-mode-functions&quot;&gt;Service Mode Functions&lt;/h1&gt;

&lt;p&gt;There are many service mode functions that Samsung kindly provides that will help during reversing.&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# Enable CP Debugging
am broadcast -a android.provider.Telephony.SECRET_CODE -d android_secret_code://66336

&amp;lt;device resets&amp;gt;

# Enable CP RAMDUMP
am broadcast -a android.provider.Telephony.SECRET_CODE -d android_secret_code://9090

&amp;lt;device resets&amp;gt;

# Cause CP RAMDUMP
am broadcast -a android.provider.Telephony.SECRET_CODE -d android_secret_code://CP_RAMDUMP

# SysDump, Copy to SD Card
am broadcast -a android.provider.Telephony.SECRET_CODE -d android_secret_code://9900
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;Working on writing up my notes on reversing &lt;code class=&quot;highlighter-rouge&quot;&gt;CP Boot Daemon&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;BOOT&lt;/code&gt;, hopefully will post soon. I still need to figure out how to organize this damn thing. Hopefully this helps those interested jump-start their research, and feel free to reach out via &lt;a href=&quot;http://twitter.com/theqlabs&quot;&gt;Twitter&lt;/a&gt;.&lt;/p&gt;
</content>
 </entry>
 

</feed>
